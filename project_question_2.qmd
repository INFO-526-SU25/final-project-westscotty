---
title: "Project Question 2"
format: 
  html:
    embed-resources: true
toc: true
editor:
  render-on-save: true
execute:
  warning: false
---

## 0 - Setup

```{r library_setup}
if (!require("pacman")) 
    install.packages("pacman")

# Use pacman::p_load to install and load CRAN packages
pacman::p_load(
    dplyr,
    # gganimate,
    ggplot2,
    ggthemes,
    ggspatial,
    glue,
    grid,
    gridExtra,
    here,
    hms,
    knitr,
    lubridate,
    openintro,
    readr,
    scales,
    sf,
    tidyverse,
    viridis
)

# Handle GitHub package separately
if (!require("dsbox")) {
      # Install devtools if not present
      if (!require("devtools")) 
          install.packages("devtools")
devtools::install_github("tidyverse/dsbox")
      library(dsbox)
}

# ggplot2::theme_set(ggplot2::theme_minimal(base_size = 14))
# options(width = 65)

# knitr::opts_chunk$set(
#   fig.width = 7.5,
#   fig.asp = 0.718,
#   fig.retina = 3,
#   fig.align = "center",
#   dpi = 300
# )
```

```{r}
vesuvius_data <- read.csv(here("data","vesuvius.csv"))
vesuvius_data <- vesuvius_data |>
    mutate(
        time = str_replace_all(time, "T", " "),
        time = str_replace_all(time, "Z", ""),
        time = as.POSIXct(time, format = "%Y-%m-%d %H:%M:%S"),
        date = as.Date(time),
        time = hms::as_hms(time)
    )

vesuvius_data_filtered <- vesuvius_data |>
    drop_na(
        latitude, 
        longitude, 
        depth_km, 
        duration_magnitude_md
    ) |>
    mutate(
        depth_boundary = case_when(depth_km < 1 ~ "< 1 km",
                                   depth_km < 2 ~ "< 2 km",
                                   depth_km < 3 ~ "< 3 km",
                                   depth_km < 4 ~ "< 4 km",
                                   depth_km < 5 ~ "< 5 km",
                                   TRUE ~ "> 5 km"),
        depth_boundary = factor(depth_boundary, 
                                levels = c("< 1 km", 
                                           "< 2 km", 
                                           "< 3 km", 
                                           "< 4 km", 
                                           "< 5 km", 
                                           "> 5 km"))
    ) |> glimpse()
```

```{r}
ggplot(
    vesuvius_data, 
    aes(x = longitude, 
        y = latitude)
) +

geom_point(
    aes(color = duration_magnitude_md,
        alpha = abs(depth_km)),
    size = 3
) +                     

scale_color_viridis_c(
    option = "inferno",
    name = "Magnitude"
) +

scale_alpha_continuous(
    name = "Depth (km)",
    range = c(0.1, 0.8)
) +

labs(
    title = "Seismic Events at Mount Vesuvius",
    subtitle = "Point Color by Magnitude (Inferno), Transparency by Depth",
    x = "Longitude",
    y = "Latitude",
    caption = NULL
) 

```

```{r}
max_depth <- max(vesuvius_data$depth_km, na.rm = TRUE)
min_depth <- min(vesuvius_data$depth_km, na.rm = TRUE)

print(paste("Maximum depth (km):", max_depth))
print(paste("Minimum depth (km):", min_depth))

max_mag <- max(vesuvius_data$duration_magnitude_md, na.rm = TRUE)
min_mag <- min(vesuvius_data$duration_magnitude_md, na.rm = TRUE)

print(paste("Maximum Magnitude:", max_mag))
print(paste("Minimum Magnitude:", min_mag))
```

```{r}
vesuvius_data_filtered <- vesuvius_data_filtered |>
    group_by(depth_boundary) |>
    mutate(
        depth_rescaled = rescale(depth_km, to = c(1, 10)),
        mag_rescaled = rescale(duration_magnitude_md, to = c(0.3, 0.9))
    ) |>
    arrange(depth_boundary, desc(depth_rescaled)) |>
    ungroup()
```

```{r}
ggplot(
    vesuvius_data_filtered,
    aes(x = longitude, y = latitude)
) +

geom_point(
    aes(color = duration_magnitude_md, 
        size = depth_rescaled,
        alpha = mag_rescaled)
) +
scale_size_identity() +
scale_color_viridis_c(
    option = "magma",
    name = "Magnitude"
) +
facet_wrap(~ depth_boundary, ncol = 2, scales = "free_y") +
scale_x_continuous(
    limits = c(14.3, 14.5),
    expand = c(0, 0)
) +
scale_y_continuous(
    limits = c(40.75, 40.9),
    expand = c(0, 0)
) +
labs(
    title = "Seismic Events at Mount Vesuvius",
    subtitle = "Faceted by Depth Category\nPoint Color = Magnitude",
    x = "Longitude",
    y = "Latitude"
) +
theme(
    panel.spacing = unit(1, "lines"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")

) +
guides(alpha = "none")
```

```{r}
ggplot(
    vesuvius_data_filtered,
    aes(x = longitude, y = latitude)
) +
annotation_map_tile(zoom = 10, type = "osm") +
geom_point(
    aes(color = duration_magnitude_md, 
        size = depth_rescaled,
        alpha = mag_rescaled)
) +
scale_size_identity() +
scale_color_viridis_c(
    option = "magma",
    name = "Magnitude"
) +
facet_wrap(~ depth_boundary, ncol = 2) +
scale_x_continuous(
    limits = c(14.3, 14.5),
    expand = c(0, 0)
) +
scale_y_continuous(
    limits = c(40.75, 40.9),
    expand = c(0, 0)
) +
labs(
    title = "Seismic Events at Mount Vesuvius",
    subtitle = "Faceted by Depth Category\nPoint Color = Magnitude",
    x = "Longitude",
    y = "Latitude"
) +
theme(
    panel.spacing = unit(1, "lines"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")

)
```